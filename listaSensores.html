<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Sensores</title>
        <!-- Enlace al favicon -->
        <link rel="icon" href="https://servicoldingenieria.com/src/favicon.png" type="image/x-icon">
        <!-- Enlace a Bootstrap 5 desde tu carpeta npm -->
        <link rel="stylesheet" href="https://servicoldingenieria.com/node_modules/bootstrap/dist/css/bootstrap.min.css">
        <!-- Enlace a tu archivo de estilos CSS -->
        <link rel="stylesheet" type="text/css" href="https://servicoldingenieria.com/css/styles.css">
        <style>
            html, body {
                height: 100%;
                margin: 0;
                padding: 0;
                background: linear-gradient(to right, #0a0a4d, #050e2d);
                font-size: 16px; /* Asegúrate de tener un tamaño base razonable */
            }
                    
    
            body {
                font-family: 'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif;
                color: #bcd3de;
                margin: 0;
                padding-bottom: 50px;
                padding-top: 0;
                background: linear-gradient(to right, #0a0a4d, #050e2d);
            }
            
            header {
                color: #bcd3de;
                background: linear-gradient(to right, #0a0a4d, #050e2d);
                border-bottom: solid;
                border-bottom-color: transparent;
                display: block;
            }
                
                p {
                    font-size: 1.4rem;
                    color: #bcd3de;
                }
                
                h1 {
                    font-size: 2.5rem; /* Ajustar tamaño para pantallas más pequeñas */
                    font-weight: 600;
                    color: #74b5f9;
                    margin-top: 15px;
                }
                
                h2, h3, h4, h5, h6 {
                    font-size: 1.5rem; /* Ajustar tamaño para pantallas más pequeñas */
                    font-weight: 500;
                    color: #74b5f9;
        
                }
                
                .logo {
                    margin-left: 100px; /* Ajustar el margen */
                    height: 40px;
                    margin-top: 10px;
                    border: none;
                }
                
                .title {
                    margin-top: 20;
                    margin-bottom: 20;
                }
                
                ul {
                    font-size: 1.4rem;
                    margin-top: 15px;
                }
                
                ul a{
                    text-decoration: none;
                    font-size: 1.4rem;
                    color: #bcd3de;
                }
                
                .btn-primary {
                    background-color: #2b78c5;
                    border-color: #2b78c5;
                    color: #e3f2fd;
                    font-size: 1.25rem;
                    margin-bottom: 15px;
                }
                
                .btn-primary:hover {
                    background-color: #0056b3;
                    border-color: #004085;
                }
                .sensor-item {
                padding: 15px;
                border: 2px solid;
                margin-bottom: 10px;
                border-radius: 5px;
                }
                .online {
                    color: green;
                }
                .offline {
                    color: red;
                }
    
                header {
                    position: fixed;
                    width: 100%;
                    top: 0;
                    left: 0;
                    z-index: 1000;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    background-color: #202733;
                    padding: 5px 10px;
                    height: 60px; /* Ajustar la altura */
                }
                
                header img {
                    height: 30px; /* Reducir el tamaño de la imagen */
                    border: none;
                }
                
                .nav-buttons {
                    display: flex;
                    gap: 10px;
                }
                
                .nav-buttons a {
                    color: #bcd3de;
                    text-decoration: none;
                    padding: 3px 8px;
                    border-radius: 5px;
                    transition: background-color 0.3s ease;
                }
                
                .nav-buttons a:hover {
                    background-color: #007bff;
                    color: #fff;
                }
                
                .nav-buttons .active {
                    background-color: #007bff;
                    color: #fff;
                }
                
                #sensorList{
                    margin-top:20px;
                    margin-bottom: 30px;
                    padding-bottom:20px;
                    padding-top: 25px;
                }
                /* Media queries para pantallas pequeñas */
                @media (max-width: 768px) {
                    .col-md-8, .col-md-4, .col-md-9, .col-md-3, .col-md-6 {
                        width: 100%;
                    }
                    p {
                        font-size: 1rem;
                        color: #bcd3de;
                    }
                    header{
                    width: 100%;
                    height: 30px;
                    }
                    
                    header img {
                    margin-left: 5px;
                    border: none;
                    }
        
                    .logo {
                    margin-left: 0; /* Ajustar el margen */
                    height: 30px;
                    margin-top: 5px;
                    margin-right: 5px;
                    border: none;
                    }
                    
                    .sensor-item  {
                        padding-right:25px;
                        padding-left:25px;
                    }
                    
                    .nav-buttons {
                        display: flex;
                        justify-content: end;
                        align-items: center;
                        height: 10px;
                        width: 5px;
                        margin-top: 5px;
                        font-size: 0.75rem;
                    }
                }
                
                @media (max-width: 576px) {
                    .section {
                        padding: 30px 10px;
                    }
                    
                    header{
                    width: 100%;
                    height: auto;
                    }
                    
                    p {
                        font-size: 1rem;
                        color: #bcd3de;
                    }
        
                
                    h1 {
                        font-size: 2rem;
                    }
                
                    h2, h3, h4, h5, h6 {
                        font-size: 1.25rem;
                    }
                
                    .btn-primary {
                        font-size: 1rem;
                        padding: 10px;
                    }
                }
        
        </style>
    </head>
    <body>
        <!-- Cabecera -->
        <header class="p-4">
            <img src="imagenes/logo-fotor-bg-remover-2024071624910.png" alt="ServiCold SAS" class="img-fluid logo">
            <div class="nav-buttons">
                <a href="home.php">HOME</a>
                <a href="index.php">GESTIÓN</a>
                <a href="https://servicoldingenieria.com/back-end/logOut.php">SALIR</a>
            </div>
        </header>
        <div class="container">
            <h1 class="title">Lista de Sensores</h1>
            <div id="sensorList"></div>
        </div>
    
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const sensorListDiv = document.getElementById('sensorList');
            
                // Función para obtener los sensores
                const fetchSensors = async () => {
                    try {
                        const response = await fetch('https://servicoldingenieria.com/back-end/sensoresUsuario.php', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                        });
            
                        if (response.ok) {
                            let sensors = await response.json();
            
                            // Almacenar las lecturas de los sensores
                            const sensorReadings = await Promise.all(sensors.map(sensor => fetchSensorReading(sensor)));
            
                            // Mostrar los sensores con sus lecturas
                            sensorReadings.forEach(({ sensor, reading }) => {
                                displaySensor(sensor, reading);
                            });
                        } else {
                            console.error('Error al obtener los sensores:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error fetching sensors:', error);
                    }
                };
            
                // Función para obtener la última lectura de cada sensor
                const fetchSensorReading = async (sensor) => {
                    try {
                        const response = await fetch(`https://servicoldingenieria.com/back-end/ultimaLectura.php?sensor_name=${sensor.nombre}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                        });
            
                        if (response.ok) {
                            const reading = await response.json();
                            return { sensor, reading };
                        } else {
                            console.error('Error al obtener la última lectura');
                            return { sensor, reading: null }; // Manejo de error
                        }
                    } catch (error) {
                        console.error('Error fetching sensor reading:', error);
                        return { sensor, reading: null }; // Manejo de error
                    }
                };
            
                // Función para mostrar cada sensor
                const displaySensor = (sensor, reading) => {
                    const sensorLink = document.createElement('a');
                    sensorLink.href = `detalleSensor.html?sensorName=${sensor.nombre}`;
                    sensorLink.style.display = 'block';
                    sensorLink.style.textDecoration = 'none';
                    sensorLink.style.color = 'inherit';
            
                    const sensorItem = document.createElement('div');
                    sensorItem.className = 'sensor-item';
                    sensorItem.style.borderColor = isSensorOnline(reading?.fecha_actual) ? 'green' : 'red';
                    sensorItem.style.borderWidth = '3px';
                    sensorItem.style.padding = '10px';
                    sensorItem.style.marginBottom = '10px';
                    sensorItem.style.backgroundColor = '#11203a';
            
                    const sensorName = document.createElement('h2');
                    sensorName.innerText = sensor.nombre;
                    sensorName.style.fontSize = '22px';
                    sensorName.style.fontWeight = 'bold';
                    sensorName.style.marginBottom = '5px';
            
                    const sensorInfo = document.createElement('p');
                    sensorInfo.innerHTML = `Última lectura:
                        ${sensor.tipo === 'temperatura' ? `  Temperatura: ${reading?.Temperatura || 'N/A'}°C ` : ` Nivel de combustible: ${reading?.nivel_combustible || 'N/A'}%`}
                        ; Fecha: ${reading ? new Date(reading.fecha_actual).toLocaleString('es-ES') : 'N/A'}<br>
                        Estado: ${isSensorOnline(reading?.fecha_actual) ? '<span class="online" style="color: green;">En línea</span>' : '<span class="offline" style="color: red;">Fuera de línea</span>'}
                    `;
            
                    sensorItem.appendChild(sensorName);
                    sensorItem.appendChild(sensorInfo);
                    sensorLink.appendChild(sensorItem);
                    sensorListDiv.appendChild(sensorLink);
                };
            
                // Función para determinar si el sensor está en línea
                const isSensorOnline = (fecha) => {
                    const now = new Date();
                    const lastReadingTime = new Date(fecha);
                    const diffMinutes = Math.abs(now.getTime() - lastReadingTime.getTime()) / (1000 * 60);
                    return diffMinutes <= 15; // Sensor en línea si la lectura fue hace menos de 15 minutos
                };
            
                // Ejecutar la función para obtener los sensores al cargar la página
                fetchSensors();
            });
        </script>
    </body>
</html>
